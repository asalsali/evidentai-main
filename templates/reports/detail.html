{% extends 'base.html' %}
{% block title %}Case #{{ report.id }} â€¢ EvidenAI-M{% endblock %}
{% block header %}Case #{{ report.id }}{% endblock %}
{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <div class="lg:col-span-2 card p-6 rounded border border-gray-800">
    <h2 class="text-lg font-semibold mb-4">Summary</h2>
    {% if report.summarized_report %}
      <pre class="whitespace-pre-wrap text-sm leading-6">{{ report.summarized_report }}</pre>
    {% else %}
      <div class="muted">No summary yet.</div>
    {% endif %}
  </div>
  <div class="card p-6 rounded border border-gray-800">
    <h2 class="text-lg font-semibold mb-4">Case Information</h2>
    
    <!-- Case Details -->
    <div class="space-y-3 mb-6">
      <div>
        <span class="text-sm font-medium text-gray-400">Incident Type:</span>
        <div class="mt-1">
          {% if report.incident_type %}
            <span class="px-2 py-1 rounded text-sm bg-gray-700">{{ report.get_incident_type_display }}</span>
          {% else %}
            <span class="muted">Not specified</span>
          {% endif %}
        </div>
      </div>
      
      <div>
        <span class="text-sm font-medium text-gray-400">Officer Badge:</span>
        <div class="mt-1">
          {% if report.officer_badge %}
            <span class="font-mono">#{{ report.officer_badge }}</span>
          {% else %}
            <span class="muted">Not specified</span>
          {% endif %}
        </div>
      </div>
      
      <div>
        <span class="text-sm font-medium text-gray-400">Incident Date:</span>
        <div class="mt-1">
          {% if report.incident_date %}
            {{ report.incident_date|date:'F d, Y' }}
          {% else %}
            <span class="muted">Not specified</span>
          {% endif %}
        </div>
      </div>
      
      {% if report.notes %}
      <div>
        <span class="text-sm font-medium text-gray-400">Notes:</span>
        <div class="mt-1 text-sm">{{ report.notes }}</div>
      </div>
      {% endif %}
    </div>
    
    <!-- Processing Status -->
    <div class="border-t border-gray-700 pt-4">
      <h3 class="text-sm font-medium mb-3">Processing Status</h3>
      <div class="space-y-2">
        <div><span class="muted">Status:</span> <span id="status-text">{{ report.status|title }}</span></div>
        <div class="w-full bg-gray-800 rounded h-2">
          <div id="progress-bar" class="bg-blue-600 h-2 rounded" style="width: {{ report.progress_percent }}%"></div>
        </div>
        <div class="text-xs muted" id="status-message">{{ report.status_message }}</div>
      </div>
    </div>
    
    <!-- Evidence Files -->
    <div class="border-t border-gray-700 pt-4 mt-4">
      <h3 class="text-sm font-medium mb-3">Evidence Files</h3>
      <div class="space-y-2">
        <div>
          <span class="muted text-xs">Original Video:</span>
          {% if report.original_video %}
            <a href="{{ report.original_video.url }}" class="underline text-blue-300" target="_blank">Download</a>
          {% else %}
            <span class="muted">N/A</span>
          {% endif %}
        </div>
        {% if report.extracted_audio %}
        <div>
          <span class="muted text-xs">Audio File:</span>
          <a href="{{ report.extracted_audio.url }}" class="underline text-blue-300" target="_blank">Download</a>
        </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Professional Report -->
    {% if report.status == 'completed' %}
    <div class="border-t border-gray-700 pt-4 mt-4">
      <h3 class="text-sm font-medium mb-3">Professional Report</h3>
      <div class="space-y-2">
        <a href="{% url 'professional_report' report.id %}" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors">
          ğŸ“„ View Professional Report
        </a>
        {% if report.summarized_report %}
        <a href="{% url 'report_pdf' report.id %}" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors">
          ğŸ“¥ Download PDF
        </a>
        {% endif %}
        <div class="text-xs muted">Print-ready official report with all case details</div>
      </div>
    </div>
    {% endif %}
    
    <!-- Digital Signature Section -->
    <div class="border-t border-gray-700 pt-4 mt-4">
      <h3 class="text-sm font-medium mb-3">ğŸ” Digital Signature</h3>
      {% if not report.signed_by %}
        <div class="space-y-2">
          {% if not user.officer_wallet %}
            <div class="p-3 bg-yellow-900/20 border border-yellow-600/30 rounded-lg">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-yellow-300">âš ï¸</span>
                <span class="text-sm text-yellow-300 font-medium">Wallet Setup Required</span>
              </div>
              <p class="text-sm text-yellow-300 mb-3">You need to set up your digital signature wallet before you can sign reports.</p>
              <a href="{% url 'setup_wallet' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-sm font-medium transition-colors">
                ğŸ”‘ Setup My Digital Wallet
              </a>
            </div>
          {% elif user.officer_wallet.has_valid_credential %}
            <div class="p-3 bg-green-900/20 border border-green-600/30 rounded-lg">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-green-300">ğŸ†</span>
                <span class="text-sm text-green-300 font-medium">XLS-70 Professional Signing Available</span>
              </div>
              <p class="text-sm text-green-300 mb-3">Sign with your XLS-70 credential for maximum legal authenticity and blockchain verification.</p>
              <div class="flex gap-2">
                <a href="{% url 'sign_report_xls70' report.id %}" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-medium transition-colors">
                  ğŸ† Sign with XLS-70 Credential
                </a>
                <a href="{% url 'sign_report' report.id %}" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition-colors">
                  âœï¸ Standard Sign
                </a>
              </div>
            </div>
          {% elif user.officer_wallet.credential_id %}
            <div class="p-3 bg-orange-900/20 border border-orange-600/30 rounded-lg">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-orange-300">â³</span>
                <span class="text-sm text-orange-300 font-medium">Credential Pending Acceptance</span>
              </div>
              <p class="text-sm text-orange-300 mb-3">Your XLS-70 credential needs to be accepted before you can use professional signing.</p>
              <div class="flex gap-2">
                <a href="{% url 'wallet_dashboard' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded text-sm font-medium transition-colors">
                  ğŸ“‹ Accept Credential
                </a>
                <a href="{% url 'sign_report' report.id %}" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition-colors">
                  âœï¸ Standard Sign
                </a>
              </div>
            </div>
          {% else %}
            <div class="p-3 bg-blue-900/20 border border-blue-600/30 rounded-lg">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-blue-300">ğŸ“</span>
                <span class="text-sm text-blue-300 font-medium">Ready to Sign</span>
              </div>
              <p class="text-sm text-blue-300 mb-3">This report is ready for your digital signature. Signing creates a permanent, tamper-proof record.</p>
              <div class="flex gap-2">
                <a href="{% url 'create_credential' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm font-medium transition-colors">
                  ğŸ† Create XLS-70 Credential
                </a>
                <a href="{% url 'sign_report' report.id %}" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition-colors">
                  âœï¸ Standard Sign
                </a>
              </div>
            </div>
          {% endif %}
          <div class="text-xs text-gray-400 mt-2">
            <strong>XLS-70 vs Standard:</strong> XLS-70 credentials provide professional-grade blockchain verification with full legal authenticity. Standard signing uses transaction memos for basic verification.
          </div>
        </div>
      {% else %}
        <div class="space-y-2">
          <div class="p-3 bg-green-900/20 border border-green-600/30 rounded-lg">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-green-300 text-lg">âœ…</span>
              <span class="text-green-300 font-medium">Report Digitally Signed</span>
            </div>
            <div class="text-sm space-y-2">
              <div class="flex justify-between">
                <span class="text-gray-400">Signed by:</span>
                <span class="text-white">{{ report.signed_by.username }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Signed on:</span>
                <span class="text-white">{{ report.signed_at|date:"M d, Y at H:i" }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Signature Type:</span>
                <span class="text-white">
                  {% if report.signature_type == 'XLS70_CREDENTIAL' %}
                    <span class="text-green-300">ğŸ† XLS-70 Professional</span>
                  {% elif report.signature_type == 'MOCK' %}
                    <span class="text-yellow-300">ğŸ§ª Mock (Testing)</span>
                  {% else %}
                    <span class="text-blue-300">ğŸ“ Standard</span>
                  {% endif %}
                </span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Signature ID:</span>
                <code class="text-xs text-green-300">{{ report.signature_tx_hash|truncatechars:16 }}...</code>
              </div>
              {% if report.credential_id %}
              <div class="flex justify-between">
                <span class="text-gray-400">Credential ID:</span>
                <code class="text-xs text-blue-300">{{ report.credential_id|truncatechars:16 }}...</code>
              </div>
              {% endif %}
            </div>
            <div class="mt-3 flex gap-2">
              <a href="{% url 'verify_signature' report.id %}" class="inline-flex items-center gap-1 px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-medium transition-colors">
                ğŸ” Verify Signature
              </a>
              <a href="https://devnet.xrpl.org/transactions/{{ report.signature_tx_hash }}" target="_blank" class="inline-flex items-center gap-1 px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded text-xs font-medium transition-colors">
                ğŸ”— View on Blockchain
              </a>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function() {
    const statusUrl = "{% url 'report_status_json' report.id %}";
    const statusText = document.getElementById('status-text');
    const statusMessage = document.getElementById('status-message');
    const progressBar = document.getElementById('progress-bar');
    function poll() {
      fetch(statusUrl).then(r => r.json()).then(d => {
        statusText.textContent = d.status;
        statusMessage.textContent = d.status_message || '';
        progressBar.style.width = (d.progress || 0) + '%';
        if (d.status !== 'completed' && d.status !== 'failed') {
          setTimeout(poll, 2500);
        }
      }).catch(() => setTimeout(poll, 3000));
    }
    if (statusText && (statusText.textContent !== 'completed' && statusText.textContent !== 'failed')) {
      setTimeout(poll, 2000);
    }
  })();
 </script>
{% endblock %}


