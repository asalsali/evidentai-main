{% extends 'base.html' %}
{% block title %}{{ title }} • EvidenAI-M{% endblock %}
{% block header %}{{ title }}{% endblock %}
{% block content %}
<div class="card p-6 rounded border border-gray-800">
  <div class="overflow-x-auto">
    <table class="min-w-full text-left text-sm">
      <thead class="border-b border-gray-800 text-gray-400">
        <tr>
          <th class="py-2 pr-4">Case #</th>
          <th class="py-2 pr-4">Incident Type</th>
          <th class="py-2 pr-4">Officer</th>
          <th class="py-2 pr-4">Date</th>
          <th class="py-2 pr-4">Status</th>
          <th class="py-2 pr-4">Report</th>
        </tr>
      </thead>
      <tbody id="reports-tbody">
      {% for r in reports %}
        <tr class="border-b border-gray-800">
          <td class="py-2 pr-4"><a href="{% url 'report_detail' r.id %}" class="underline text-blue-300">#{{ r.id }}</a></td>
          <td class="py-2 pr-4">
            {% if r.incident_type %}
              <span class="px-2 py-1 rounded text-xs bg-gray-700">{{ r.get_incident_type_display }}</span>
            {% else %}
              <span class="muted">Not specified</span>
            {% endif %}
          </td>
          <td class="py-2 pr-4">
            {% if r.officer_badge %}
              <span class="font-mono text-sm">Badge #{{ r.officer_badge }}</span>
            {% else %}
              <span class="muted">Not specified</span>
            {% endif %}
          </td>
          <td class="py-2 pr-4">
            {% if r.incident_date %}
              {{ r.incident_date|date:'M d, Y' }}
            {% else %}
              {{ r.created_at|date:'M d, Y' }}
            {% endif %}
          </td>
          <td class="py-2 pr-4">
            <span class="px-2 py-1 rounded border border-gray-700 text-xs" data-report-status="{{ r.id }}">{{ r.status|title }}</span>
            <div class="w-32 bg-gray-800 rounded h-1 mt-1">
              <div class="bg-blue-600 h-1 rounded" style="width: {{ r.progress_percent }}%" data-report-progress="{{ r.id }}"></div>
            </div>
          </td>
          <td class="py-2 pr-4">
            {% if r.summarized_report %}
              <span class="text-green-400">✓ Ready</span>
            {% elif r.transcript_text %}
              <span class="text-yellow-400">⏳ Processing</span>
            {% else %}
              <span class="muted">Pending</span>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="6" class="py-8 text-center muted">No cases found.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
(function(){
  const rows = document.querySelectorAll('[data-report-status]');
  function pollOne(id){
    fetch(`/api/reports/${id}/status/`).then(r=>r.json()).then(d=>{
      const statusEl = document.querySelector(`[data-report-status="${id}"]`);
      const progEl = document.querySelector(`[data-report-progress="${id}"]`);
      if(statusEl){ statusEl.textContent = d.status; }
      if(progEl){ progEl.style.width = (d.progress||0)+"%"; }
      if(d.status !== 'completed' && d.status !== 'failed'){
        setTimeout(()=>pollOne(id), 3000);
      }
    }).catch(()=>setTimeout(()=>pollOne(id), 4000));
  }
  rows.forEach(el=>{
    const id = el.getAttribute('data-report-status');
    if(el.textContent !== 'completed' && el.textContent !== 'failed'){
      setTimeout(()=>pollOne(id), 2000);
    }
  });
})();
</script>
{% endblock %}


