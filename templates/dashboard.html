{% extends 'base.html' %}
{% block title %}Evidence Processing Center • EvidenAI-M{% endblock %}
{% block header %}Evidence Processing Center{% endblock %}
{% block content %}

<!-- Welcome Section -->
<div class="mb-6 p-4 bg-blue-900/20 border border-blue-800 rounded-lg">
  <div class="flex items-center gap-3">
    <div class="text-2xl">🚔</div>
    <div>
      <h2 class="text-lg font-semibold text-blue-300">Welcome to Evidence Processing</h2>
      <p class="text-sm text-blue-200">Upload bodycam footage to generate comprehensive incident reports automatically</p>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  
  <!-- Upload Section -->
  <div class="lg:col-span-2">
    <div class="card p-6 rounded border border-gray-800">
      <div class="flex items-center gap-3 mb-4">
        <div class="text-xl">📹</div>
        <h2 class="text-lg font-semibold">Submit Bodycam Evidence</h2>
      </div>
      
      <form action="{% url 'upload_video' %}" method="post" enctype="multipart/form-data" class="space-y-4">
        {% csrf_token %}
        
        <!-- File Upload Area -->
        <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
          <div class="text-4xl mb-2">📁</div>
          <p class="text-sm mb-2">Drag and drop your bodycam video here</p>
          <p class="text-xs muted mb-4">or click to browse files</p>
          {{ form.original_video }}
          <div class="text-xs muted mt-2">Supported: MP4, AVI, MOV • Max size: 500MB</div>
        </div>
        
        <!-- Incident Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Incident Date</label>
            {{ form.incident_date }}
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Officer Badge #</label>
            {{ form.officer_badge }}
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1">Incident Type</label>
          {{ form.incident_type }}
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1">Additional Notes (Optional)</label>
          {{ form.notes }}
        </div>
        
        <button type="submit" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-500 rounded font-medium flex items-center justify-center gap-2">
          <span>🚀</span>
          <span>Process Evidence & Generate Report</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Recent Cases -->
  <div class="card p-6 rounded border border-gray-800">
    <div class="flex items-center gap-3 mb-4">
      <div class="text-xl">📋</div>
      <h2 class="text-lg font-semibold">Recent Cases</h2>
    </div>
    
    <div class="space-y-3" id="recent-reports">
      {% for r in reports %}
      <div class="border border-gray-700 rounded p-3 hover:bg-gray-800/50 transition-colors">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="font-medium text-blue-300">
              <a href="{% url 'report_detail' r.id %}" class="hover:underline">Case #{{ r.id }}</a>
            </div>
            <div class="text-xs muted">{{ r.created_at|date:'M d, Y - g:i A' }}</div>
            <div class="text-xs text-gray-400 mt-1">
              {% if r.status == 'completed' %}
                <div class="space-y-1">
                  <span class="text-green-400">✓ Report Ready</span>
                  <div>
                    <a href="{% url 'professional_report' r.id %}" class="text-blue-400 hover:underline">📄 Professional Report</a>
                  </div>
                </div>
              {% elif r.status == 'failed' %}
                <span class="text-red-400">✗ Processing Failed</span>
              {% else %}
                <span class="text-yellow-400">⏳ Processing...</span>
              {% endif %}
            </div>
          </div>
          <div class="text-right">
            <div class="w-24 bg-gray-800 rounded h-1.5">
              <div class="bg-blue-600 h-1.5 rounded transition-all duration-300" 
                   style="width: {{ r.progress_percent }}%" 
                   data-report-progress="{{ r.id }}"></div>
            </div>
            <div class="text-xs muted mt-1" data-report-status="{{ r.id }}">{{ r.status|title }}</div>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="text-center py-8">
        <div class="text-4xl mb-2">📹</div>
        <p class="muted">No cases submitted yet</p>
        <p class="text-xs muted">Upload your first bodycam video to get started</p>
      </div>
      {% endfor %}
    </div>
    
    <!-- Quick Actions -->
    <div class="mt-6 pt-4 border-t border-gray-700">
      <div class="text-sm font-medium mb-3">Quick Actions</div>
      <div class="space-y-2">
        <a href="{% url 'reports_all' %}" class="block px-3 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm transition-colors">
          📊 View All Cases
        </a>
        <a href="{% url 'reports_completed' %}" class="block px-3 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm transition-colors">
          ✅ Completed Reports
        </a>
        <a href="{% url 'reports_in_progress' %}" class="block px-3 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm transition-colors">
          ⏳ Processing Queue
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Processing Status Legend -->
<div class="mt-6 p-4 bg-gray-800/50 rounded-lg">
  <h3 class="text-sm font-medium mb-3">Processing Status Guide</h3>
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-xs">
    <div class="flex items-center gap-2">
      <div class="w-3 h-3 bg-gray-600 rounded"></div>
      <span>Pending</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-3 h-3 bg-yellow-500 rounded"></div>
      <span>Processing</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-3 h-3 bg-blue-500 rounded"></div>
      <span>Analyzing</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-3 h-3 bg-green-500 rounded"></div>
      <span>Complete</span>
    </div>
  </div>
</div>
<script>
(function(){
  const rows = document.querySelectorAll('[data-report-status]');
  function pollOne(id){
    fetch(`/api/reports/${id}/status/`).then(r=>r.json()).then(d=>{
      const statusEl = document.querySelector(`[data-report-status="${id}"]`);
      const progEl = document.querySelector(`[data-report-progress="${id}"]`);
      if(statusEl){ statusEl.textContent = d.status; }
      if(progEl){ progEl.style.width = (d.progress||0)+"%"; }
      if(d.status !== 'completed' && d.status !== 'failed'){
        setTimeout(()=>pollOne(id), 3000);
      }
    }).catch(()=>setTimeout(()=>pollOne(id), 4000));
  }
  rows.forEach(el=>{
    const id = el.getAttribute('data-report-status');
    if(el.textContent !== 'completed' && el.textContent !== 'failed'){
      setTimeout(()=>pollOne(id), 2000);
    }
  });
})();
</script>
{% endblock %}


